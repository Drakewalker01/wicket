<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">HitWicket | Live Sports</title>
    
    <link rel="preload" href="highquality.json" as="fetch" crossorigin="anonymous">

    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <style>
        body { background-color: #0b1120; color: #ffffff; margin: 0; font-family: sans-serif; }
        .glass-panel { background: #0f172a; border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        .video-wrapper { aspect-ratio: 16/9; background: #000; }
        .skeleton-card { background: #1e293b; height: 180px; border-radius: 1rem; animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>

    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" media="print" onload="this.media='all'" />
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"></noscript>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.6/controls.min.css">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Rajdhani', 'sans-serif'] },
                    colors: { neonBlue: '#00f3ff', neonPurple: '#bc13fe', darkBg: '#0b1120' },
                }
            }
        }
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.6/shaka-player.ui.min.js" defer></script>

    <style>
        button { all: revert; } 
        .shaka-video-container { box-sizing: border-box; }
        body { min-height: 100vh; overflow-x: hidden; }
        
        .unified-player-container {
            border-radius: 1.5rem; overflow: hidden; background: #000; 
            border: 1px solid rgba(255,255,255,0.1); position: relative;
        }

        .channel-card { 
            position: relative; background: #1e293b; border-radius: 1rem; overflow: hidden; display: flex; padding: 2px; 
            transition: 0.3s all ease-in-out; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5); contain: content;
        }
        .channel-card::before { 
            content: ""; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; 
            background: conic-gradient(transparent 0deg, transparent 250deg, #00f3ff 300deg, #ffffff 360deg); 
            animation: rotate 4s linear infinite; z-index: 0; opacity: 0; transition: opacity 0.3s ease; will-change: transform, opacity;
        }
        .channel-card:hover::before { opacity: 1; }
        
        .card-content { 
            background: #0f172a; border-radius: 0.9rem; width: 100%; position: relative; z-index: 1; 
            display: flex; flex-direction: column; align-items: center; padding: 1rem; 
        }

        .channel-card:hover { transform: translateY(-5px); }
        .channel-card:hover::before { animation-duration: 1.5s; }
        @keyframes rotate { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .video-wrapper { position: relative; width: 100%; padding-top: 56.25%; }
        .video-wrapper [data-shaka-player-container] { position: absolute; top: 0; left: 0; bottom: 0; right: 0; width: 100%; height: 100%; }

        /* Error Overlay (Z-Index 50 - Top most) */
        .status-overlay { position: absolute; inset: 0; background: #000; display: none; justify-content: center; align-items: center; z-index: 50; }
        .status-overlay.show { display: flex; }

        /* Spinner Overlay (Z-Index 40 - Below Error, Above Video) */
        #loading-spinner { position: absolute; inset: 0; display: flex; justify-content: center; align-items: center; background: rgba(0,0,0,0.4); z-index: 40; pointer-events: none; }
        #loading-spinner.hidden { display: none; }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0b1120; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #00f3ff; }
        .shaka-overflow-menu-button { display: block; }
    </style>
</head>
<body class="antialiased flex flex-col items-center">

    <nav class="w-full glass-panel sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 h-20 flex items-center justify-between">
            <a href="index.html" class="flex items-center gap-2 no-underline">
                <i class="fas fa-cricket text-3xl text-neonBlue"></i>
                <h1 class="text-3xl font-bold uppercase italic tracking-wider text-white">Hit<span class="text-neonBlue">Wicket</span></h1>
            </a>
            
            <div class="flex items-center gap-2 px-3 py-1 rounded-full bg-red-500/10 border border-red-500/50">
                <span class="relative flex h-3 w-3">
                    <span class="animate-ping absolute h-full w-full rounded-full bg-red-500 opacity-75"></span>
                    <span class="relative h-3 w-3 bg-red-600 rounded-full"></span>
                </span>
                <span class="text-xs font-bold text-red-400">LIVE NOW</span>
            </div>
        </div>
    </nav>

    <main class="w-full max-w-7xl px-4 py-8 z-10 flex-grow">
        
        <section class="mb-12">
            <div class="unified-player-container">
                <div class="video-wrapper">
                    <div data-shaka-player-container>
                        <video data-shaka-player id="video" autoplay style="width:100%;height:100%"></video>
                    </div>

                    <div id="loading-spinner" class="hidden">
                        <div class="relative w-16 h-16">
                             <div class="absolute w-full h-full border-4 border-slate-700 rounded-full"></div>
                             <div class="absolute w-full h-full border-4 border-t-neonBlue border-r-transparent border-b-transparent border-l-transparent rounded-full animate-spin"></div>
                        </div>
                    </div>

                    <div id="status-overlay" class="status-overlay show">
                        <div class="text-center p-4">
                            <i class="fas fa-tv text-4xl text-gray-600 mb-3" id="status-icon"></i>
                            <p class="text-xl font-bold text-gray-300" id="error-msg">Select a Channel to Start</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-slate-900/95 backdrop-blur-xl border-t border-white/10 p-4 flex justify-between items-center">
                    <div>
                        <h2 class="text-xl md:text-2xl font-bold text-white" id="ch-name">Welcome</h2>
                        <span class="text-xs font-medium text-gray-400 uppercase" id="ch-quality">Live Sports Network</span>
                    </div>
                    <div class="px-4 py-2 bg-neonBlue text-black rounded-lg text-xs font-black">LIVE HD</div>
                </div>
            </div>
        </section>

        <section>
            <div class="flex items-center gap-4 mb-8">
                <div class="h-8 w-1 bg-neonBlue rounded-full"></div>
                <h2 class="text-2xl font-bold uppercase tracking-widest text-white">Full HD <span class="text-neonBlue">Channels</span></h2>
            </div>
            
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6" id="channelGrid">
                <div class="skeleton-card"></div>
                <div class="skeleton-card"></div>
                <div class="skeleton-card"></div>
                <div class="skeleton-card"></div>
                <div class="skeleton-card"></div>
            </div>
        </section>

    </main>

    <footer class="w-full py-10 border-t border-gray-800 bg-slate-900/50 backdrop-blur-md mt-auto text-center text-gray-500 text-sm">
        Â© 2026 HITWicket Sports Network.
    </footer>

    <script>
        // Global variables
        let channelsData = null;
        let selectedChannelId = new URLSearchParams(window.location.search).get('id');

        async function loadGrid() {
            try {
                const res = await fetch(`highquality.json`);
                const data = await res.json();
                channelsData = data; 

                const activeChannels = data.channels.filter(c => 
                    (c.mpdUrl && c.mpdUrl.trim() !== "") || (c.streamUrl && c.streamUrl.trim() !== "")
                );

                const gridContainer = document.getElementById('channelGrid');

                if (activeChannels.length > 0) {
                    gridContainer.innerHTML = activeChannels.map(c => `
                        <a href="?id=${c.id}" class="channel-card cursor-pointer group no-underline">
                            <div class="card-content">
                                <div class="w-full aspect-square rounded-lg mb-3 bg-slate-800 overflow-hidden relative">
                                    <img src="${c.logo}" class="w-full h-full object-cover group-hover:scale-110 transition duration-500" 
                                             onerror="this.style.display='none';">
                                </div>
                                <p class="font-bold text-center text-sm text-gray-100 truncate w-full">${c.name}</p>
                                <span class="text-[10px] uppercase tracking-wider text-neonBlue mt-1 bg-neonBlue/10 px-2 py-0.5 rounded">${c.quality || 'LIVE'}</span>
                            </div>
                        </a>
                    `).join(''); 
                } else {
                    gridContainer.innerHTML = `<p class="text-gray-400 col-span-full text-center py-10">No channels available.</p>`;
                }

                if (selectedChannelId) {
                    const ch = channelsData.channels.find(c => c.id === selectedChannelId);
                    if (ch) {
                        document.getElementById('page-title').innerText = ch.name + " | HIT Wicket";
                        document.getElementById('ch-name').innerText = ch.name;
                        document.getElementById('ch-quality').innerText = ch.quality || "HD Stream";
                    }
                }

            } catch (err) {
                console.error("Grid Error:", err);
                document.getElementById('channelGrid').innerHTML = `<p class="text-red-400 col-span-full text-center">Failed to load channels.</p>`;
            }
        }

        loadGrid(); 

        async function initApp() {
            shaka.polyfill.installAll();
            if (shaka.Player.isBrowserSupported()) {
                
                const video = document.getElementById('video');
                const overlay = document.getElementById('status-overlay');
                const spinner = document.getElementById('loading-spinner');
                const errorMsg = document.getElementById('error-msg');
                const statusIcon = document.getElementById('status-icon');
                
                const ui = video['ui'];
                const config = {
                    'controlPanelElements': ['play_pause', 'time_and_duration', 'spacer', 'quality', 'mute', 'volume', 'fullscreen', 'overflow_menu'],
                    'overflowMenuButtons': ['captions', 'cast', 'playback_rate', 'picture_in_picture']
                };
                ui.configure(config);

                const controls = ui.getControls();
                const player = controls.getPlayer();

                // Low Latency Config
                player.configure({
                    streaming: {
                        bufferingGoal: 3,
                        rebufferingGoal: 1,
                        retryParameters: { maxAttempts: 3, baseDelay: 1000 },
                        lowLatencyMode: true,
                        jumpLargeGaps: true
                    }
                });

                // --- SPINNER LOGIC ---
                // Show spinner when buffering starts
                player.addEventListener('buffering', (event) => {
                    if (event.buffering) {
                        spinner.classList.remove('hidden'); // Show spinner
                    } else {
                        spinner.classList.add('hidden');    // Hide spinner
                    }
                });

                // Hide spinner when playing starts
                video.addEventListener('playing', () => {
                    spinner.classList.add('hidden');
                    overlay.classList.remove('show');
                });

                // Handle Errors
                player.addEventListener('error', (e) => {
                    console.error('Shaka Error:', e.detail);
                    spinner.classList.add('hidden'); // Hide spinner on error
                    overlay.classList.add('show');
                    statusIcon.className = "fas fa-exclamation-triangle text-4xl text-red-500 mb-3";
                    errorMsg.innerText = "Stream Error";
                });

                if (!channelsData) {
                    await new Promise(r => setTimeout(r, 500)); 
                }

                if (channelsData && selectedChannelId) {
                    const ch = channelsData.channels.find(c => c.id === selectedChannelId);
                    if (ch) {
                        overlay.classList.remove('show');
                        
                        // Show spinner immediately before load
                        spinner.classList.remove('hidden');

                        const videoUrl = ch.mpdUrl || ch.streamUrl;
                        
                        if(ch.drm && ch.drm.clearKeys) {
                            player.configure({ drm: { clearKeys: ch.drm.clearKeys } });
                        }
                        
                        console.log("Starting Player...");
                        try {
                            await player.load(videoUrl);
                            // Note: Spinner will hide when 'playing' event fires
                        } catch (e) {
                            console.error("Load failed", e);
                            spinner.classList.add('hidden');
                        }
                    } else {
                         overlay.classList.add('show');
                         errorMsg.innerText = "Channel Not Found";
                    }
                } else {
                    overlay.classList.add('show');
                    if(!selectedChannelId) {
                        statusIcon.className = "fas fa-arrow-down text-4xl text-neonBlue mb-3 animate-bounce";
                        errorMsg.innerText = "Select a Channel";
                    }
                }
            }
        }

        document.addEventListener('shaka-ui-loaded', initApp);

        // --- ADVERTISEMENT LOGIC ---
        const AD_URL = "https://intermediategillsevent.com/1b/0f/68/1b0f68c09c17308c6b0d92ee85311590.js";
        const AD_COOLDOWN_MINUTES = 1; 

        function manageAds() {
            const lastShown = localStorage.getItem('ad_last_shown_time');
            const now = Date.now();
            if (!lastShown || (now - parseInt(lastShown) > AD_COOLDOWN_MINUTES * 60 * 1000)) {
                const script = document.createElement('script');
                script.type = 'text/javascript'; script.src = AD_URL; script.async = true;
                document.body.appendChild(script);
                localStorage.setItem('ad_last_shown_time', now.toString());
            }
        }
        setTimeout(manageAds, 3000);
    </script>
</body>
</html>
